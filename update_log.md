### v3.5.0.1 更新内容 🎨 UI 优化 & 动态头像支持 & BUG 修复

**✨ 新功能：**
- 🖼️ **动态头像支持** - 优先使用用户的动态头像（animated_avatar），头像加载采用懒加载缓存机制
- 📅 **来站天数显示** - 用户信息区域显示「来 L站/IF站 xx 天」，悬浮显示注册日期
- 🎯 **自定义 Tooltip** - 全新设计的自定义 Tooltip 系统，替代浏览器默认提示框，风格统一美观

**🎨 UI/UX 优化：**
- 🔘 **关注/粉丝按钮重构** - 改为纯文字链接样式，点击「关注 X」打开关注列表，点击「X 粉丝」打开粉丝列表
- 🚪 **注销按钮优化** - 按钮背景改为浅红色，仅悬浮时加粗，视觉更柔和
- 📝 **话题卡片统一** - 已读话题卡片的左侧边框样式与其他卡片保持一致
- 🏷️ **话题标签配色** - 话题标签使用浅蓝色背景，与整体卡片主题协调
- ✅ **我的话题悬浮修复** - 修复「我的话题」卡片悬浮时边框重复显示的问题
- 📍 **确认对话框居中** - 修复注销确认对话框位置偏移的问题
- 🏠 **站点名称显示** - 正确显示「L站」或「IF站」（根据当前访问的站点）

**🐛 Bug 修复：**
- 🔧 修复关注/粉丝按钮样式问题（原按钮带边框背景，现改为纯文字）
- 🔧 修复确认弹窗不居中的问题
- 🔧 修复站点名称判断逻辑错误
- 🔧 修复话题卡片边框样式不一致的问题

---

### v3.5.0.0 更新内容 🎉 全新「我的活动」功能

**✨ 新增「我的活动」标签页：**
- 📖 **已读** - 查看最近阅读历史，快速回顾浏览过的话题
- ⭐ **收藏** - 管理所有收藏的话题，一目了然
- 💬 **回复** - 查看所有回复记录，包含回复内容和时间
- ❤️ **赞过** - 浏览点赞历史，包含点赞时间和内容详情
- 📝 **我的话题** - 查看发布的所有话题及状态信息

**👥 新增关注与粉丝功能：**
- 👀 **关注列表** - 快速查看关注的用户
- 💖 **粉丝列表** - 查看关注你的用户
- 🔄 **数据缓存** - 本地缓存1分钟，支持强制刷新
- 📊 **数量统计** - 在用户信息区显示关注/粉丝数量
- 🖼️ **精美图标** - 全新设计的 SVG 图标

**🎨 界面优化：**
- 📱 **紧凑卡片布局** - 活动卡片采用紧凑设计，信息密度更高
- 📐 **响应式适配** - 不同屏幕尺寸下自适应布局
- 🎯 **时间文本换行** - 解决时间显示被截断的问题
- 🖱️ **悬浮交互增强** - 卡片悬浮时显示淡蓝色背景和阴影

**🐛 Bug 修复：**
- 🔧 **修复 IDCFlare 阅读时间无法记录** - 解决 fallback 路径未初始化追踪器的问题
  - 原因：当 connect 页面解析走 fallback 路径时，`tracker.init()` 未被调用
  - 修复：在 `_showFallbackStats` 中确保阅读追踪器正确初始化

---

### v3.4.9.0 更新内容 🍎 Safari/Mac 兼容性修复

**🔧 Safari/iOS/Mac 兼容性增强：**
- 🍎 **添加 `pageshow`/`pagehide` 事件监听** - Safari 上比 `visibilitychange` 更可靠
  - 解决某些 Safari 用户切换标签页时 `visibilitychange` 不触发的问题
  - 支持从 bfcache 恢复时正确重置状态
- 👆 **事件捕获阶段监听** - 使用 `capture: true` 优先捕获用户活动事件
  - 防止其他脚本阻止事件冒泡导致活动检测失败
- 🎯 **增强焦点事件处理** - 同时监听 `window` 和 `document` 的 `focus` 事件
  - `focus` 时直接设置 `isActive = true`（Safari 上更可靠）
  - 添加 `blur` 事件监听，窗口失焦时保存数据
- 💾 **localStorage 降级处理** - 隐私模式或存储不可用时自动成为领导者
  - 解决隐私模式下 TabLeader 无法正常工作的问题

**🛡️ 健壮性增强：**
- 🔍 **定时器健康检查** - 每 60 秒检查追踪定时器是否存活
  - 如果定时器意外被清除，自动重新启动
  - 防止因浏览器节流或扩展冲突导致的追踪停止
- 🛡️ **事件绑定错误保护** - `_bindEvents()` 添加 try-catch
  - 即使部分事件绑定失败，也不影响其他功能
  - 降级处理确保基本功能可用

**📝 代码优化：**
- 事件名列表存储为实例属性，便于 `destroy()` 时准确移除
- 移除监听器时 `capture` 参数与添加时保持一致

---

### v3.4.8.9 更新内容 🔄 同步修复 & UI 体验优化

**🐛 Bug 修复：**
- 🔧 **修复新设备登录后阅读时间显示异常** - 云同步后趋势页统计卡片未更新
  - 问题：云同步下载完成后，`ldsp-rd-stats` 显示的时间仍为 0
  - 原因：云同步是异步执行的，数据更新后未通知 UI 刷新
  - 修复：添加 `reading:synced` 事件，同步完成后自动刷新趋势页面
- 🔧 **修复阅读追踪器空闲检测逻辑** - 移除可能导致误判的自动恢复逻辑
  - 问题：`else if` 分支在检测到用户未活动后可能自动恢复活动状态
  - 修复：`isActive` 只通过用户活动事件设置为 true，不再自动恢复
- 🔧 **修复休眠检测后的流程问题** - 检测到休眠后立即返回，避免后续代码覆盖状态
- 🔧 **修复 `reading:synced` 事件处理器变量错误** - 使用正确的属性名和方法

**📡 事件机制增强：**
- 🆕 **新增 `reading:synced` 事件** - 阅读数据云同步完成后触发
- 🔄 **自动刷新 UI** - 同步完成后更新阅读时间变量、趋势页面、顶部状态
- 🧹 **完善 `destroy()` 清理** - 确保所有事件监听器被正确移除

**🎨 UI/UX 优化：**
- 📍 **默认位置改为左上角** - 首次安装插件，面板默认显示在屏幕左上角
- 📏 **窗口缩放位置保护** - 当浏览器窗口缩小导致面板超出视口边界时，自动调整位置
  - 检测右边界溢出：面板自动左移到可见区域内
  - 检测左边界溢出：面板位置修正到最小边距
  - 检测上下边界溢出：面板垂直位置自动调整
  - 调整后的位置会自动保存，下次打开保持新位置

**🎯 今日趋势数据实时化：**
- 📊 **今日阅读时间实时更新** - 趋势页"今日"标签现在显示实时追踪的阅读时间
  - 之前：使用缓存变量 `this.readingTime`，可能不是最新值
  - 现在：使用 `tracker.getTodayTime()` 获取实时数据

---

### v3.4.8.8 更新内容 🔧 阅读追踪全面优化

**🎯 活动检测增强：**
- 🖱️ **扩展活动事件监听** - 新增 mousemove、wheel、pointermove、click、pointerdown 等事件
  - 解决 Mac 触控板用户活动无法检测的问题
  - 高频事件（如 mousemove）采用 3 秒节流，避免性能影响
  - 普通事件采用 1 秒节流，保证响应及时性
- 👁️ **窗口焦点监听** - 窗口获得焦点时更新活动状态

**💤 系统休眠检测：**
- 🔍 **智能休眠识别** - 检测定时器间隔异常（大于正常间隔3倍）
  - 系统休眠时 JavaScript 定时器暂停，恢复后会出现大间隔
  - 自动重置活动状态，避免休眠期间的时间被错误计入
- 📊 **休眠事件日志** - 记录休眠检测便于问题排查

**🛡️ 数据保存防护：**
- ⏰ **异常时间过滤** - 拒绝负数或超过 2 分钟的时间跨度
  - 防止系统时间调整导致的异常数据
  - 防止休眠恢复时的大块时间被错误记录
- 📉 **单次保存上限** - 限制为保存间隔的 1.5 倍（约 45 秒）
  - 确保即使有异常也不会记录过多时间

**🐛 修复问题：**
- 修复部分用户始终显示"未活动已停止记录"的问题
- 修复电脑休眠后唤醒，时间被持续错误计入的问题

---

### v3.4.8.7 更新内容 🐛 阅读时间追踪修复

**🐛 Bug 修复：**
- 🔧 **修复阅读时间无法正常记录的问题** - 部分用户反馈显示"未活动已停止记录"但实际有活动
  - 原因：多标签页领导者机制在页面刷新后可能导致追踪定时器未启动
  - 修复：活动状态检测始终运行，仅数据保存由领导者执行
- 🛡️ **添加追踪定时器防重复保护** - 防止多次启动导致的异常
- ⏱️ **优化领导者超时时间** - 从15秒缩短到10秒，减少等待时间

---

### v3.4.8.6 更新内容 🔒 认证与同步优化

**🔒 认证机制增强：**
- 🛡️ **前置登录状态校验** - 所有需要登录的操作在请求前检查登录状态，过期 Token 不再发送请求
- ⏰ **Token 过期容错时间增加** - 减少客户端与服务端时间差异导致的边界情况
- � **友好的登录失效提示** - 登录过期时给出明确提示，引导用户重新登录

**⚡ 云同步性能优化：**
- 🔄 **多标签页智能同步** - 仅主标签页执行同步，避免重复请求
- 📦 **数据传输压缩** - 减少同步数据量，提升响应速度
- 🛡️ **前置数据有效性检查** - 跳过空数据的无意义请求

**🎫 排行榜与工单系统：**
- 🔒 加强登录状态校验，未登录时及时反馈
- 💬 登录失效时提示更友好

**📉 优化效果：**
- 减少无效网络请求，节省流量
- 提升多标签页使用体验
- 操作响应更及时，错误提示更清晰

---

### v3.4.8.5 更新内容 🔧 代码质量与稳定性优化

**🌈 UI 优化：**
- ✨ **阅读统计卡片背景** - 背景色随阅读等级动态变化
  - 背景色使用等级对应颜色的浅色版本（透明度 0.08）
  - 不同等级呈现不同的主题色调
- 💎 **等级徽章浮雕效果** - 更突出的视觉表现
  - 使用等级对应颜色的发光阴影（透明度 0.4）
  - 顶部高光营造立体浮雕感
  - 微上移效果增强悬浮感
  - 图标随等级动态变化

**�🏗️ 代码架构优化：**
- 🆕 **新增 Logger 模块** - 统一的日志管理系统
  - 可控制日志输出级别，生产环境减少冗余输出
  - 支持按模块标签分类日志
- 🆕 **新增 EventBus 事件总线** - 模块间通信机制
  - 替代全局 window 事件，降低耦合度
  - 支持订阅/发布模式和一次性监听
- 🆕 **新增 NetworkError 错误类** - 统一的网络错误处理
  - 包含错误码、HTTP 状态码等结构化信息
  - 方便识别超时、认证、服务器错误等类型

**🔧 Utils 工具增强：**
- 🆕 `toSafeNumber()` / `toSafeInt()` - 安全的数值转换，防止 NaN
- 🆕 `deepFreeze()` - 深度冻结对象，防止意外修改
- 🆕 `isValidUrl()` - URL 格式验证
- 🆕 `get()` - 安全获取嵌套属性（类似 lodash.get）
- 🆕 `clone()` - 浅拷贝对象
- 🆕 `uid()` - 生成唯一标识符
- 🆕 `safeAsync()` - Promise 异常安全执行

**⚡ Panel 类重构：**
- 📦 初始化逻辑拆分为独立方法，提高可读性
  - `_initManagers()` - 管理器实例化
  - `_initState()` - 状态变量初始化
  - `_initUI()` - UI 组件初始化
  - `_initCloudServices()` - 云服务初始化
  - `_initEventListeners()` - 事件监听器
  - `_initTimers()` - 定时任务
- 🛡️ 添加 `_destroyed` 标记，防止销毁后的无效操作
- 🧹 `destroy()` 方法增强，完整清理所有资源

**🔒 安全性增强：**
- HTML 实体映射改为实例属性，避免重复创建
- TabLeader 添加存储异常捕获，提高容错性
- 趋势 Tab 值兼容性检查，修复无效值问题

---

### v3.4.8.4 更新内容 🏗️ 多标签页架构优化

**🐛 Bug 修复：**
- 🔧 **修复阅读时间超过物理上限问题**
  - 问题：用户反馈阅读时间统计异常，每天记录超过 24 小时
  - 原因：多个标签页同时独立记录阅读时间，导致重复计时累加
  - 修复：引入跨标签页领导者选举机制，确保同一时刻只有一个标签页记录时间

**🏗️ 架构重构：**
- 🆕 **新增 TabLeader 全局单例** - 跨标签页协调核心模块
  - 基于 localStorage 实现领导者选举算法
  - 5 秒心跳检测 + 15 秒超时自动切换领导者
  - 标签页关闭时自动释放领导者，其他标签页接管
  - 支持回调订阅，组件可响应领导者状态变化

**⚡ 多标签页性能优化：**
- 📖 **阅读时间记录** - 只有领导者标签页记录阅读时间
- 🏆 **排行榜同步** - 只有领导者标签页执行定期同步
- ☁️ **云端数据同步** - 只有领导者标签页执行上传/下载
- 🔄 **面板数据刷新** - 只有领导者标签页执行定期刷新
- 📉 **效果**：多标签页场景下重复 API 请求降低 80%+

**🎫 工单系统优化：**
- ⚡ **未读数检查缓存** - 跨标签页共享缓存（30 秒有效期）
- 🔒 **登录状态校验** - API 调用前检查登录状态，避免无效请求

---

### v3.4.8.3 更新内容 🔧 网络请求优化

**优化：**
- 🔧 **网络请求优化** - 改进跨域请求处理逻辑

---

### v3.4.8 更新内容 📱 移动端升级进度优化

**Bug 修复：**
- 🔧 **修复 connect.linux.do 访问失败** - 修复升级要求获取时的 CORS 错误
  - 问题：部分用户反馈获取升级要求时报 403 错误和 CORS 拒绝
  - 原因：`RequirementsUI.fetch()` 中存在重复的 fallback 逻辑，且使用了 `mode: 'cors'`
  - 修复：移除冗余的 native fetch fallback，统一使用 `network.fetch()` 的标准流程
  - 效果：GM_xmlhttpRequest 正常绕过 CORS，不再触发无效的 native fetch

---

### v3.4.8 更新内容 📱 移动端升级进度优化

**移动端数据获取优化：**
- 🔄 **云端数据同步** - 移动端优先从服务端获取桌面端同步的升级要求数据
  - 桌面端解析 connect 页面后自动同步到云端
  - 移动端直接读取云端数据，无需解析页面
  - 完美解决移动端浏览器获取数据受限的问题
- 📊 **完整的升级要求** - 2-4 级用户显示完整的 14 项升级/保持要求
  - 包括：访问次数、回复话题、浏览话题、已读帖子、点赞、获赞等
  - 正确显示反向要求（被举报、被禁言、被封禁等）
- 🔙 **智能降级** - 如果云端没有数据，自动从 summary API 获取基础统计
- 🔐 **OAuth 信息优先** - 移动端优先使用登录缓存的用户信息
  - 确保用户名和等级显示正确

**网络请求优化：**
- 核心网络请求函数添加 fallback 机制
- 双重保障确保数据获取的可靠性

---

### v3.4.7 更新内容 🔧 信任等级显示修复 & Header 布局优化 & 全功能开放

**功能升级：**
- 🎉 **全用户功能开放** - 移除信任等级限制，所有用户都可使用完整功能
  - 0-4 级用户均可使用云同步、排行榜等全部功能
  - linux.do 和 idcflare.com 两个站点都已支持排行榜
  - 简化代码逻辑，移除不必要的信任等级检查

**UI 优化：**
- 🔐 **登录按钮优化** - 未登录时在操作区域显示"点击登录"按钮
  - 移动端友好的登录入口，位置更明显
  - 已登录用户显示注销和工单按钮
- 🚪 **注销确认对话框** - 面板内嵌注销确认，体验更流畅
  - 替换浏览器原生 confirm 弹窗
  - 响应式设计适配各种屏幕尺寸
  - 点击遮罩层可取消操作
- 🎨 **热力图优化** - 全新的柔和绿色系配色
  - 颜色更加养眼，降低视觉疲劳
  - 调整等级区间：<1分、1-60分、1-3小时、3-5小时、>5小时
  - 各等级颜色区分更明显
- 📜 **滚动条优化** - 更精致的滚动体验
  - 滚动时才显示，停止后自动隐藏
  - 隐藏两端箭头，更简洁的外观
  - 深色模式使用柔和灰蓝色，浅色模式使用主题蓝色

**Bug 修复：**
- 🔧 **信任等级显示修复** - 修复 iOS Safari + Stay 扩展下信任等级显示为 0 的问题
  - 后端返回数据字段命名统一为 `trust_level`（原为 `trustLevel`）
  - 前端兼容两种字段命名，避免旧缓存导致问题
  - 修复登录后面板显示等级 0 的 bug
- 🔧 **等级铭牌显示修复** - 修复 Lv 显示错误（如 "Lv2 → Lv21"）
  - 修复类型错误：字符串 "2" + 1 = "21" 的 bug
  - 修复 0 级用户被错误识别为 2 级的边界情况
  - 增加 OAuth 用户信息作为等级来源的 fallback
  - 现在所有等级（0-4）在各种场景下都能正确显示
- 🔧 **折叠态 Logo 居中修复** - 修复桌面端折叠后 Logo 偏下的问题
  - 重置 .ldsp-toggle 按钮的 margin/padding 确保正确居中
  - 移除折叠态 Header 的 min-height 干扰
- 🔧 **手机端按钮点击状态修复** - 修复操作按钮点击后高亮不恢复的问题
  - 添加 :active 样式定义按下状态
  - 使用 `@media (hover:none)` 禁用触控设备的 hover 粘滞
- 🔧 **阅读提示文字溢出修复** - 修复手机端"阅读时间记录中"超出边界
  - 调整 .ldsp-user 底部 padding 为提示文字留出空间
  - 各断点分别优化：默认 24px、480px 20px、500px高度 18px
  - 手机端提示文字缩小到 7px 适应有限空间

**UI 优化：**
- 📐 **Header 布局重构** - 重新设计 Header 区域的响应式布局
  - 优化各尺寸下的元素间距和大小，避免挤压和遮挡
  - 320px/480px/768px/1920px 多断点精细适配
  - 按钮大小统一优化，更紧凑的视觉效果
  - 小屏设备自动隐藏版本号等次要信息

**受影响用户：**
- iOS Safari + Stay 扩展用户需重新登录一次
- 其他平台用户自动兼容，无需操作

---

### v3.4.6 更新内容 🔧 登录修复 & 移动端优化 & 同步增强

**登录流程修复：**
- 🚀 **脚本启动时机优化** - 使用 `document-start` 提前捕获登录数据
  - 解决 Discourse SPA 路由清除 URL hash 导致登录失败的问题
  - 确保登录回调数据在页面路由处理前被捕获
- 🔄 **登录状态同步修复** - 修复登录成功后面板仍显示未登录的问题
  - 同步保存登录信息，确保后续状态检查正确
  - 登录成功后立即刷新信任等级数据
- 📱 **移动端登录优化** - 首次登录后正确显示信任等级（不再显示0级）

**移动端体验优化：**
- 🎯 **折叠状态触摸优化** - 修复拖动结束后 Logo 高亮残留问题
  - 使用 `@media (hover:hover)` 限制 hover 效果只在桌面端生效
  - 触摸结束时清除视觉残留效果
- ✨ **拖动动画优化** - 使用 `animation-play-state` 替代 `animation:none`
  - 拖动结束后动画从暂停位置继续，而非重新开始
  - 避免面板内容视觉"刷新"效果

**数据同步增强：**
- ☁️ **首次登录同步完善** - 登录后自动执行完整同步流程
  - 阅读数据：先下载云端，再合并上传
  - 要求历史：同步下载云端进度数据
- 🔄 **多设备同步可靠** - 确保多设备数据正确合并（取较大值）

---

### v3.4.5 更新内容 🔐 登录重构 & 界面优化

**登录方式重构：**
- 🔄 **统一同窗口登录** - 登录流程全面改为同窗口跳转模式
  - 彻底解决弹窗被拦截问题
  - 解决跨窗口 postMessage 通信失败问题
  - 完美兼容 iOS Safari + Stay 扩展环境
  - 适配各种浏览器隐私设置和扩展环境
- 📱 **移动端体验提升** - iOS/Android 设备登录更顺畅
- 🔒 **安全性保持** - 继续使用安全的认证机制
- ✅ **向后兼容** - 已登录用户不受影响

**新功能：**
- 🔍 **了解论坛信任等级** - 要求页面底部新增提示链接，点击跳转到论坛信任等级说明帖
- 🚪 **快捷退出登录** - 点击 Header 的站点图标可退出登录（带确认提示）

**响应式布局优化：**
- 📱 **Header 布局重构** - 优化 flex 布局，确保操作按钮不会遮挡文字
- 🔧 **768px 断点优化** - 调整字体大小和间距，标题和按钮不再挤压
- 📐 **480px 断点优化** - 进一步缩小元素尺寸，适配小屏手机
- ✨ **站点图标提示** - 鼠标悬停时显示"点击退出登录"提示（小屏隐藏）

**技术改进：**
- ✨ 移除弹窗模式相关代码，简化登录逻辑
- 📝 登录结果通过 localStorage 安全传递
- 🔧 优化回调页面 UI 和跳转体验
- 💡 添加超时自动显示手动返回按钮

---

### v3.4.1 更新内容 🔧 兼容性与稳定性提升

**浏览器兼容性：**
- 🌐 全面测试并优化主流浏览器兼容性（Chrome / Firefox / Edge / Safari）
- 📱 改善移动端浏览器和扩展管理器（如 Stay）的运行稳定性

**动画优化：**
- ✨ 修复部分 CSS 动画在特定浏览器下不流畅或失效的问题
- 🎯 优化过渡效果，减少视觉抖动

---

### v3.4.0 更新内容 🎫 工单反馈系统 & 全新配色方案 & 0-1级用户功能全开放

**新功能：工单反馈**
- 🎫 **反馈工单** - 用户区域下方新增"反馈工单"按钮
  - 按钮位于头像和用户名下方，全宽居中显示
  - 支持提交功能建议、BUG反馈等工单
  - 可查看历史工单和回复记录
  - 管理员回复后有红点提示

**数据获取优化：**
- 📊 **低等级用户数据获取优化**
  - 0-1级用户现在也可以查看信任等级升级进度啦！
  - 数据来源更稳定可靠
  - 提升数据获取速度和准确性

**全新配色方案：**
- 🎨 **主题色重设计** - 采用优雅的靛蓝色 + 青色配色
  - 主色调：靛蓝色（#6b8cef → #5a7de0）
  - 辅助色：青色（#5bb5a6 → #7cc9bc）
  - 整体更加专业、舒适、不刺眼
- 🌙 **深色主题优化** - 采用深邃的 #12131a 背景
- ☀️ **浅色主题优化** - 配色协调统一

**折叠状态优化：**
- ✨ **Logo 图标** - 折叠时显示 Orbit Pulse 品牌 Logo
- 💫 **点亮效果** - 悬浮/点击时 Logo 发光点亮动画
- 🎯 **展开箭头** - 展开状态显示方向箭头

**界面细节优化：**
- 📱 **移动端响应式** - 手机端面板最大高度限制为 60vh
- 🔥 **热力图颜色** - 单元格和图例颜色统一为新配色
- 📜 **滚动条优化** - 热力图使用更细的4px滚动条
- 📊 **月度图表优化** - 日期标签字号根据天数动态调整（31天用7px，28天用8px，其他用9px），避免拥挤
- 🔥 **年热力图** - 打开"本年"时自动滚动到今天位置（热力图底部）
- 🎯 **阅读卡片彩蛋** - 点击阅读时间卡片可跳转到 LDStatus Pro 官网

**多站点兼容：**
- 🖼️ **IDCFlare 头像修复** - 排行榜头像正确显示

---

### v3.3.2 更新内容 📢 系统公告功能

**新功能：**
- 📢 **系统公告栏** - 支持管理员发布滚动公告
  - 客户端面板顶部显示滚动文字公告
  - 支持三种公告类型：通知（蓝色）、警告（黄色）、喜报（绿色）
  - 支持设置公告有效期（北京时间），到期自动隐藏
  - 公告始终显示，用户无法关闭
  - 滚动速度根据文字长度自动调整
  - 管理面板「系统设置」新增公告配置区域

---

### v3.3.1 更新内容 🎉 动画修复 & 审计优化

**Bug修复：**
- 🐛 **修复等级徽章闪烁动画失效** - `ldsp-ring-lvl` shimmer 动画不显示
  - 原因：使用 `background` 简写属性覆盖了 `background-size`
  - 修复：改用 `background-image` 只设置渐变，保留基类的 `background-size: 200% 100%`

**服务端优化：**
- 📊 **审计统计平均响应时间计算优化**
  - 原实现：简单取平均 `(a + b) / 2`，在请求数量差距大时不准确
  - 新实现：使用加权平均，根据每个时段的请求数量加权计算
- 🗓️ **审计统计日期分组逻辑修复**
  - 原实现：week7 包含 today，导致累加时重复计数
  - 新实现：使用互斥区间（today / week7-不含today / month30-不含week7）

**客户端优化：**
- ⚡ **渲染性能优化** - 需求列表使用数组构建 + join() 代替字符串拼接

**云同步性能深度优化：**
- ✨ **增量同步优先** - 只同步当天的升级要求数据，同步间隔 1小时
- 🔄 **条件全量同步** - 仅在首次登录或本地数据天数多于云端时触发，间隔 12小时
- 📉 **效果** - sync-full 请求减少约 90%

---

### v3.3.0  🎨 全面 UI/UX 重构 & 动态配置

**🔧 服务端动态配置：**
- ☁️ **阅读等级云端配置** - 等级区间和名称从服务端动态获取
  - 客户端启动时自动获取配置，本地缓存 24 小时
  - 管理员可在后台「系统设置」中修改等级区间和名称
  - 图标和颜色使用预设顺序，保证视觉一致性

**默认等级配置：**
| 等级 | 区间 | 图标 | 颜色 |
|-----|------|-----|------|
| 刚起步 | 0-30分钟 | 🌱 | 灰色 |
| 热身中 | 30-90分钟 | 📖 | 蓝色 |
| 渐入佳境 | 90-180分钟 | 📚 | 绿色 |
| 沉浸阅读 | 180-300分钟 | 🔥 | 黄色 |
| 深度学习 | 300-450分钟 | ⚡ | 橙色 |
| LD达人 | 450-600分钟 | 🏆 | 紫色 |
| 超级水怪 | 600+分钟 | 👑 | 粉色 |

**全新交互体验：**
- 🎉 **100%完成度庆祝动画** - 进度达到100%时触发礼炮撒花效果
  - 28个彩色碎片从圆环中心爆发散开
  - 碎片向四周炸开后自然下落
  - 多彩形状（●■★❤✨❀）和颜色
- ✨ **等级徽章动效** - `ldsp-ring-lvl` 全新视觉效果
  - 鼠标悬浮时 360° 翻转动画
  - 渐变色流动闪烁效果
  - 不同等级不同配色:
    - Lv1: 灰色渐变（低调稳重）
    - Lv2: 蓝色渐变（成长中）
    - Lv3: 紫青渐变（活跃用户）
    - Lv4: 金橙红渐变 + 光晕（领导者尊贵）

**圆环区域重构：**
- 📊 **信息密度提升** - 圆环左右两侧新增统计卡片
  - 左侧：已达标数量（绿色✓）
  - 右侧：待完成数量（红色○）
- 🏷️ **等级进度显示** - 圆环下方显示 `Lv2 → Lv3` 升级目标
  - 普通用户最高 Lv3（Lv4 需管理员授予）
  - 达到上限显示 `Lv3 ★` 或 `Lv4 ★`
- 💬 **智能提示文案** - 根据状态显示不同提示
  - 进行中：⏳ 距升级还需完成 X 项要求
  - 已满足：🎉 已满足升级条件
  - 已达上限：🎖️ 已达普通用户最高等级

**阅读追踪优化：**
- 🌊 **动态波纹效果** - 追踪状态时显示呼吸波纹
  - 波纹颜色随阅读时长变化（绿→黄→橙→紫→粉）
  - 未追踪时显示红色"未活动 已停止记录"提示
- 🔔 **状态类分离** - `.tracking` 类控制追踪状态，`.hi/.max` 类控制阅读等级

**头部区域优化：**
- 🖼️ **站点图标增大** - 26px → 28px，更醒目
- 📝 **版本号优化** - 字体增大，位于图标下方
- ✨ **应用名闪烁** - LDStatus Pro 添加颜色脉冲动画
- 📏 **标题字体增大** - 网站名 15px，应用名 12px

**用户区域精简：**
- 👤 **头像增大** - 44/48/52px（小/中/大屏）
- 📝 **用户名增大** - 昵称 16px，ID 12px  
- 🗑️ **移除冗余信息** - 等级和完成度已在圆环区域展示
- ⚖️ **阅读卡片居中** - 调整上下边距保持视觉平衡

**子标签栏修复：**
- ✅ 垂直居中对齐
- ✅ 上下间距均衡（4px 上 / 6px 下）
- ✅ 显示滚动条便于横向滑动

**设计系统升级：**
- 🎨 **全新配色方案** - 专业级的色彩系统
  - 深色主题：采用深邃的 `#0c0c14` 主背景，配合玻璃拟态卡片效果
  - 浅色主题：使用带透明度的白色系，更加通透优雅
  - 新增更多语义化颜色变量：`--accent-light`, `--accent2-light`, `--accent3` 等
  - 增强的阴影系统：添加 `--shadow-lg`, `--shadow-glow`, `--glow-accent` 等发光效果

**视觉效果提升：**
- ✨ **玻璃拟态设计** - 面板和卡片采用 `backdrop-filter: blur()` 效果
- 🌈 **渐变优化** - 更丰富的渐变色，按钮和进度条使用三色渐变
- 💫 **微交互动画** - 更流畅的 hover、active 状态过渡
  - 按钮悬停时上浮+缩放效果
  - 卡片悬停时微妙的阴影增强
  - 数值更新时的弹性动画

**组件样式重构：**
- 📋 **头部区域**
  - 站点图标改为圆角矩形，悬停时旋转效果
  - 版本号使用胶囊形状设计
  - 操作按钮增加毛玻璃背景
- 👤 **用户卡片**
  - 头像改为圆角矩形，添加发光边框效果
  - 用户名支持渐变色文字
  - 阅读时间卡片增加顶部发光边
- 📊 **需求列表**
  - 图标采用圆形背景容器
  - 悬停时右移+阴影效果
  - 变化标签添加微妙阴影
- 📈 **图表组件**
  - 柱状图使用双色渐变
  - 热力图格子采用圆角设计
  - 工具提示样式细化
- 🏆 **排行榜**
  - 前三名使用金属质感渐变
  - 排名数字采用圆角方块设计
  - 我的排名卡片添加装饰性渐变光斑

**响应式布局优化：**
- 📱 **大屏优化 (≥1920px)**：面板宽度增至 340px，字体和间距适当放大
- 📱 **中等屏幕 (≤768px)**：优化按钮和图标尺寸，保持可点击区域
- 📱 **小屏设备 (≤480px)**：精简设计，保证核心功能可用性
- 📱 **超矮屏 (≤500px)**：隐藏非必要元素，最大化内容空间

**UX 改进：**
- 🎯 **滚动条美化** - 使用主题色渐变条，悬停时高亮
- 🎯 **空状态优化** - 更大的图标和更友好的提示文案
- 🎯 **加载状态** - Toast 提示采用胶囊形状，更流畅的进出动画
- 🎯 **模态框升级** - 圆角增大，添加边框光晕效果

---

### v3.2.7 更新内容 ⚡ D1 写入优化 & UI/UX 升级

**后端优化 (backend)：**
- ⚡ **D1 写入额度优化** - 综合节省约 70% 写入
  - 🅰️ 移除周/月统计实时更新 - 改由 Cron 预计算排行榜时聚合 (节省 ~40%)
  - 🅱️ 降低 `last_sync` 更新频率 - 每 10 分钟最多更新一次 (节省 ~20%)
  - 只在需要更新时才写入数据库，避免无意义写入
- 🔄 **客户端版本记录优化** - 在更多接口支持版本更新
  - 用户状态 API - 同步更新
  - 排行榜 API - 后台异步更新
  - 只在版本变化时更新，减少写入

**客户端优化 (LDStatusPro.user.js)：**
- 🧠 **智能同步 (方案E)** - 只在阅读时间变化时才发送同步请求 (节省 ~30%)
  - 缓存上次同步的分钟数，相同则跳过
  - 用户不活跃时完全不消耗写入额度
- 📱 **响应式布局优化** - 适配手机和小屏设备
  - 默认位置改为**右上角**（更符合通用习惯）
  - 小屏幕 (≤768px): 面板宽度 280px，右对齐
  - 超小屏 (≤480px): 面板宽度 260px，右对齐
  - 超矮屏 (≤500px): 隐藏阅读时间区域，内容区自适应
- 📲 **移动端拖拽支持** - 添加触摸事件
  - 支持 touchstart/touchmove/touchend 事件
  - `touch-action:none` 阻止默认滚动手势
  - 折叠状态下也可拖动
- 🎨 **顶部 Header 优化**
  - 版本号移到网站名称下方，**恢复 tag 样式**（带背景色）
  - 顶部 padding 减小，高度更紧凑
  - 标题和按钮尺寸自适应
- 🎉 **新版本提醒优化**
  - 气泡样式更紧凑，带三角箭头指向按钮
  - 更新按钮增加红点提示 (has-update)
  - 动画效果更平滑

**写入额度优化效果：**
| 指标 | 优化前 | 优化后 | 节省 |
|-----|-------|-------|-----|
| 每次同步写入 | 4 次 | 1 次 | 75% |
| 无效同步请求 | 100% | ~30% | 70% |
| **1000 日活写入** | ~100,000 | ~30,000 | **70%** |

---

### v3.2.6 更新内容 🛡️ Token 过期处理 & 审计写入优化

**后端优化 (backend)：**
- 🔐 **JWT Token 有效期延长** - 24小时 → 30天
  - 减少用户重新登录频率
- ⚡ **审计日志内存聚合** - 大幅减少 D1 Rows Written
  - 请求统计在内存中累积，每分钟或每100请求批量写入
  - 每次请求从 3-5 次写入 → 平均 0.03 次写入 (节省 99%)
- 🗑️ **移除用户版本实时更新** - 减少无意义写入

**客户端优化 (LDStatusPro.user.js)：**
- 🔒 **Token 过期检测** - 登录状态检查时验证 Token 是否过期
  - 解析 JWT payload 的 exp 字段
  - 提前 5 分钟判定为过期，避免请求时刚好过期
- ⚠️ **401 错误自动处理** - API 请求失败时检测 Token 过期
  - 自动登出并触发 UI 刷新
  - 显示"登录已过期，请重新登录"提示
- 📦 **错误消息增强** - 包含错误码便于问题诊断

---

### v3.2.4 更新内容 ⚡ D1 查询深度优化

**后端优化 (backend)：**
- ⚡ **排行榜 N+1 查询修复** - 大幅减少数据库查询
  - `_buildLeaderboard`: 100次查询 → 2次查询 (节省 98%)
  - `_getUserRankInList`: 500次查询 → 2次查询 (节省 99%)
- 📦 **新增批量方法** - `getUsersMap()`, `batchUpsertWeeklyReadings()`, `batchUpsertMonthlyReadings()`
- 🔄 **用户统计重建优化** - 42次写入 → 2次 batch (节省 95%)
- 🛠️ **Admin 端点优化** - `update-user-site` 5次写入 → 1次 batch
- 🐛 **审计统计修复** - `unique_ips`/`unique_users` 计数逻辑修正

---

### v3.2.4 更新内容 🌟 新功能 & 时区修复

**客户端优化 (LDStatusPro.user.js)：**
- 🌄 **默认主题改为浅色** - 新用户默认体验浅色主题
- 📱 **版本号上报** - 每次 API 请求携带客户端版本 (X-Client-Version)

**后端优化 (backend)：**
- 🕒 **时间统一为北京时间** - 所有时间相关函数使用 UTC+8
  - 时间工具：新增北京时间获取和格式化函数
  - 审计日志、数据统计等均使用北京时间
  - 提供迁移脚本转换已有数据
- 📊 **记录用户客户端版本** - users 表新增 `client_version` 字段
  - 每次认证请求自动更新版本信息

**管理面板优化：**
- 👤 **用户管理** - 列表和详情显示客户端版本

---

### v3.2.3 更新内容 🔧 同步接口稳定性修复

**客户端优化 (LDStatusPro.user.js)：**
- 📉 **阅读数据上传优化** - 修复 reading/sync-full 500 错误
  - 只上传最近 90 天数据（最多 100 条）
  - 减少请求体大小，降低后端处理压力
- 🎫 **trust_level 权限检查优化** - 从 OAuth 用户信息获取等级
  - 避免低等级用户请求 requirements 接口

**后端优化 (backend)：**
- 🛡️ **D1 批量操作加固** - 批量写入方法增强
  - 批次大小从 50 减少到 20
  - 添加批次失败回退机制，单条插入保证数据不丢失
- 👤 **RequirementsService 自动创建用户** - 修复 404 错误
  - 三个方法均支持用户首次访问时自动创建记录

---

### v3.2.2 更新内容 ⚡ D1 免费额度优化

**客户端优化 (LDStatusPro.user.js)：**
- ⏰ **同步间隔优化** - 降低后端请求频率
  - 排行榜同步: 10分钟 → 15分钟
  - 云上传: 30分钟 → 60分钟
  - 云下载: 6小时 → 12小时
  - 云检查: 5分钟 → 10分钟
  - 新增升级要求同步间隔: 2小时
- 🔄 **指数退避重试** - 失败后自动增加等待时间
  - 首次失败等待 1 分钟，最大 30 分钟退避
  - 成功后自动重置
- 🎫 **权限缓存** - trust_level 检查结果缓存 24 小时
  - 低等级用户不再重复请求 requirements 接口
- 🚦 **串行化同步** - 页面加载时避免并发请求压力
  - reading 同步完成后再同步 requirements
  - 排行榜首次同步延迟 5 秒
- 📊 **排行榜缓存优化**
  - 日榜: 5分钟 → 10分钟
  - 周榜: 1小时 → 2小时
  - 月榜: 3小时 → 6小时

**后端优化 (backend)：**
- 📦 **批量写入** - 历史同步使用批量操作
  - reading: 每日数据批量写入，周/月统计按分组更新
  - requirements: 批量读取服务器数据，批量写入新数据
- 📖 **批量读取** - 一次查询获取所有历史数据，避免逐条查询
- 🗄️ **新增批量方法** - 批量更新每日阅读数据

**预期效果：**
- D1 读取次数: 减少约 70%
- D1 写入次数: 减少约 80%
- API 请求频率: 降低约 50%

---
### v3.2.1 更新内容 🌐 IDCFlare 全功能支持

**新功能：**
- 🌐 **IDCFlare 排行榜和云同步** - IDCFlare 站点现已支持完整的排行榜和云同步功能
  - 与 Linux.do 站点功能完全一致
  - 支持阅读时间排行榜（日榜/周榜/月榜）
  - 支持阅读数据云同步
  - 支持升级要求历史云同步 (trust_level >= 2)

**后端更新：**
- 🔐 **多站点 OAuth 支持** - 后端服务现支持多站点认证
  - 新增 IDCFlare OAuth 配置
  - 站点信息通过 URL 参数传递
  - 回调 URL 包含站点标识

**技术改进：**
- 前端 OAuth 请求携带 `site` 参数
- 后端 AuthService 支持动态站点配置
- 头像 URL 根据站点自动构建

---
### v3.2.0 更新内容 🔒 安全与性能优化

**安全增强（后端）：**
- 🛡️ **新增安全工具模块**
  - 全面的输入验证函数（用户ID、日期、分钟数等）
  - XSS 防护：HTML 字符转义函数
  - 字符串净化：移除控制字符、长度限制
  - JSON 安全：深度检查、大小限制
  - 升级要求数据验证
- 🔐 **服务层安全强化**
  - 所有服务使用安全模块验证输入
  - 强化数据验证和权限检查
  - 验证用户输入格式，限制参数范围

**安全增强（前端）：**
- 🛡️ **XSS 防护** - 新增 `Utils.escapeHtml()` 和 `Utils.sanitize()` 函数
- 🔒 **排行榜渲染安全** - 用户名和显示名称经过转义处理
- 🔐 **用户信息显示安全** - 清理所有用户输入再显示

**性能优化（后端）：**  
- ⚡ **用户缓存** - 数据库层新增内存缓存，30秒 TTL
- 🚀 **缓存失效机制** - 用户数据更新时自动清除缓存

**性能优化（前端）：**
- ⚡ **API 响应缓存** - Network 类支持 GET 请求缓存
- 🔄 **请求去重** - 避免重复发送相同请求
- 📉 **减少 API 调用** - 缓存排行榜等高频请求

---
### v3.1.2 更新内容 🐛 趋势统计修复

**问题修复：**
- 🔧 **"全部"趋势标签页统计修复** - 修复"共记录 X 天数据"显示不正确的问题
  - 之前：错误地使用时间跨度计算，导致显示1天
  - 现在：正确使用 `history.length` 作为实际记录天数
- 📊 **日均阅读时间计算优化** - 使用实际有阅读记录的天数计算日均值
- ✨ **新增跨度显示** - 当跨度天数大于记录天数时，额外显示"跨度 X 天"
- 📈 **累计变化显示优化** - 添加当前值/目标值 (current/required) 显示

**UI改进：**
- 新增 `.ldsp-chg-cur` 样式，用于显示当前/目标值

---
### v3.1.1 更新内容 🔧 细节优化

**代码改进：**
- ⚡ **排行榜更新规则动态化** - 排行榜统计周期不再写死，而是从配置动态读取
  - 日榜: 每 5 分钟更新 (对应 `LEADERBOARD_DAILY_TTL`)
  - 周榜: 每 60 分钟更新 (对应 `LEADERBOARD_WEEKLY_TTL`)
  - 月榜: 每 3 小时更新 (对应 `LEADERBOARD_MONTHLY_TTL`)
- 🎯 修改配置即可自动更新显示文案，无需同步修改多处代码

**用户信息区域确认：**
- 头像（带悬停"查看"提示）
- 昵称 (displayName) + @用户名 (username)
- 信任等级 (Lv X)
- 升级要求进度 (X/Y 完成)

---
### v3.1.0 更新内容 ☁️ 升级要求数据云同步

**新增功能：**
- ☁️ **升级要求历史云同步** - 支持升级要求数据的跨设备同步
  - 自动上传本地升级要求历史到云端
  - 新设备登录时自动下载云端数据
  - 数据合并策略：取各字段的较大值，防止数据丢失
  - **权限要求**: 仅 `trust_level >= 2` 用户可用

**UI/UX 改进：**
- 🎨 **头像悬停提示** - 头像悬停时显示"查看"tooltip
- 👤 **用户名显示优化** - 登录后正确显示昵称而非仅用户名

**问题修复：**
- 🔧 修复 `_bindLoginPrompt()` 中按钮禁用状态设置错误的问题
- 🔧 修复 `oauth.getUser()` 方法不存在的调用错误
- 🔧 修复登录后界面未正确更新用户信息的问题

**后端更新 (v3.2.0)：**
- 新增 `requirements_history` 数据表
- 新增升级要求同步 API，支持单日同步、完整历史上传和历史数据获取

---
### v3.0.4 更新内容 🐛 Bug修复与体验优化

**问题修复：**
- 🔧 **低信任等级用户体验修复** - 修复 trust_level < 2 用户无法正常使用的问题
  - 修复 "Cannot read properties of undefined (reading '$')" 错误
  - 登录后正确显示用户信息（头像、昵称、等级）
  - 不再卡在"加载中"状态
- 🔧 **事件绑定修复** - 修复排行榜登录/加入按钮点击后被禁用的问题
  - 使用箭头函数替代 `.bind(this)` 避免 this 指向错误
  - 按钮状态正确更新

**交互优化：**
- 🎨 **头像交互增强** - 头像悬停时显示缩放和发光效果

**代码改进：**
- ✨ 新增 `_updateUserInfoFromOAuth()` 方法，从 OAuth 数据更新用户界面
- ⚡ 页面加载时自动显示已登录用户信息

---
### v3.0.3 更新内容 🎨 体验优化与功能增强

**排行榜优化：**
- 🎨 **用户显示样式升级** - 排行榜现在显示 name + @username 组合
  - 有昵称时：粗体昵称 + 浅色小号用户名
  - 无昵称时：保持原有粗体用户名样式
- 🔄 **手动刷新功能** - 排行榜统计周期旁新增刷新按钮
  - 支持手动获取最新排行榜数据
  - 5分钟冷却时间，各榜独立计算
  - 刷新时显示旋转动画和状态提示

**缓存策略优化：**
- ⏱️ **前端缓存时间调整**
  - 日榜：5分钟（与服务器更新频率匹配）
  - 周榜：60分钟
  - 月榜：3小时

**版本更新提醒：**
- 🎉 **智能更新气泡** - 发现新版本时显示醒目的气泡提示
  - 显示当前版本 → 新版本对比
  - 一键点击立即更新
  - 关闭后同版本不再重复提示
  - 检查按钮有更新时显示脉冲动画

**趋势显示修复：**
- 📊 本月/本年趋势数据显示条件优化（1条记录即可显示）

**信任等级兼容：**
- 🔐 **信任等级 < 2 支持** - 现在低信任等级用户也能使用阅读时间追踪功能
  - 无法获取升级要求时显示友好提示
  - 阅读追踪功能正常运行

**代码优化：**
- 🚀 重构排行榜事件绑定逻辑，消除重复代码
- ⚡ 使用 onclick 替代重复的 addEventListener，避免内存泄漏

---
### v3.0.1 更新内容 🚀 架构升级 - 存储迁移至 D1
**重大更新：**
- 🗄️ **存储后端迁移** - 从 Cloudflare KV 迁移到 D1 SQL 数据库
  - 写入限额从 1,000/天 提升到 100,000/天（**100 倍提升**）
  - 读取限额从 100,000/天 提升到 5,000,000/天（50 倍提升）
  - 存储空间从 1GB 提升到 5GB（5 倍提升）
  - 支持约 10,000-20,000 日活用户，原先仅支持 100-200 人

**技术改进：**
- 新增数据库工具类封装所有数据库操作
- 排行榜计算使用 SQL 聚合查询，性能大幅提升
- 数据完全无损迁移，用户无感知升级
- 保留 KV 绑定用于迁移期间兼容

---
### v3.0.0 更新内容 🎉 重大更新 - 排行榜功能上线

**新增功能:**
- 🏆 **排行榜系统** - 全新的排行榜功能，与其他用户一较高下
  - 支持日榜、周榜、月榜三个时间维度
  - 展示前 50 名用户的阅读时间排名
  - 金银铜牌前三名特殊展示效果
- 🔐 **OAuth 登录** - 使用 Linux.do 账号安全授权
- 🛡️ **隐私优先** - 用户自主选择是否加入排行榜，随时可退出
- 👤 **我的排名** - 查看自己在各榜单中的位置
- 📡 **数据同步** - 阅读时间自动同步到云端排行榜

**技术实现:**
- 新增 `OAuthManager` 类处理 OAuth2 认证流程
- 新增 `LeaderboardManager` 类管理排行榜数据
- 新增排行榜 Tab UI 和相关样式
- 后端使用 Cloudflare Workers + KV 存储

**其他:**
- 版本号升级到 3.0.0
- 更新 README 文档

---
### v3.0.1 更新内容 🔧 修复与性能优化
**修复与改进：**
- 修复 OAuth 登录后用户名未同步到本地 storage 的问题（导致云同步无法正确读取/写入用户数据）
- 修复云端下载超时问题：将后端 KV 读取从串行改为并行，并批处理以提升性能
- 优化历史数据接口，使用批量获取用户全部阅读记录，避免时区或缺失数据问题
- 添加手动同步按钮（顶部 ☁️），支持完整的下载+上传流程
- 同步过程中按钮显示加载状态并禁用点击，防止重复触发
- 优化客户端缓存策略，日榜客户端缓存改为 5 分钟，服务器端 Cron 改为每 10 分钟计算
- 修复其他小 bug 与 UX 改进

**其他:**
- 版本号升级到 3.0.1
- 更新 README 与 DOCS 文档说明

---
### v2.8.7更新内容
- 现在缩小后的悬浮图标也支持拖动啦，展开和收缩动画优化。
- 修复明暗主题切换可能出现的UI闪烁问题。
- 增量统计部分的显示和数据调整。
- 一些动画优化和调整。