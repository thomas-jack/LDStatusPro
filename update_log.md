### v3.2.6 更新内容 🛡️ Token 过期处理 & 审计写入优化

**后端优化 (backend)：**
- 🔐 **JWT Token 有效期延长** - 24小时 → 30天
  - 减少用户重新登录频率
- ⚡ **审计日志内存聚合** - 大幅减少 D1 Rows Written
  - 请求统计在内存中累积，每分钟或每100请求批量写入
  - 每次请求从 3-5 次写入 → 平均 0.03 次写入 (节省 99%)
- 🗑️ **移除用户版本实时更新** - 减少无意义写入

**客户端优化 (LDStatusPro.user.js)：**
- 🔒 **Token 过期检测** - 登录状态检查时验证 Token 是否过期
  - 解析 JWT payload 的 exp 字段
  - 提前 5 分钟判定为过期，避免请求时刚好过期
- ⚠️ **401 错误自动处理** - API 请求失败时检测 Token 过期
  - 自动登出并触发 UI 刷新
  - 显示"登录已过期，请重新登录"提示
- 📦 **错误消息增强** - 包含错误码便于问题诊断

---

### v3.2.4 更新内容 ⚡ D1 查询深度优化

**后端优化 (backend)：**
- ⚡ **排行榜 N+1 查询修复** - 大幅减少数据库查询
  - `_buildLeaderboard`: 100次查询 → 2次查询 (节省 98%)
  - `_getUserRankInList`: 500次查询 → 2次查询 (节省 99%)
- 📦 **新增批量方法** - `getUsersMap()`, `batchUpsertWeeklyReadings()`, `batchUpsertMonthlyReadings()`
- 🔄 **用户统计重建优化** - 42次写入 → 2次 batch (节省 95%)
- 🛠️ **Admin 端点优化** - `update-user-site` 5次写入 → 1次 batch
- 🐛 **审计统计修复** - `unique_ips`/`unique_users` 计数逻辑修正

---

### v3.2.4 更新内容 🌟 新功能 & 时区修复

**客户端优化 (LDStatusPro.user.js)：**
- 🌄 **默认主题改为浅色** - 新用户默认体验浅色主题
- 📱 **版本号上报** - 每次 API 请求携带客户端版本 (X-Client-Version)

**后端优化 (backend)：**
- 🕒 **时间统一为北京时间** - 所有时间相关函数使用 UTC+8
  - `time.js`: 新增 `getBeijingNow()`, `formatBeijingTime()` 等函数
  - 审计日志、数据统计等均使用北京时间
  - 提供迁移脚本 `migrate-utc-to-beijing.sql` 转换已有数据
- 📊 **记录用户客户端版本** - users 表新增 `client_version` 字段
  - 每次认证请求自动更新版本信息

**管理面板优化 (admin-panel)：**
- 👤 **用户管理** - 列表和详情显示客户端版本

**迁移脚本：**
```bash
# 待部署后执行，转换时间为北京时间
npx wrangler d1 execute ldstatus-pro-db --file=scripts/migrate-utc-to-beijing.sql
# 添加客户端版本字段
npx wrangler d1 execute ldstatus-pro-db --file=scripts/migrate-add-client-version.sql
```

---

### v3.2.3 更新内容 🔧 同步接口稳定性修复

**客户端优化 (LDStatusPro.user.js)：**
- 📉 **阅读数据上传优化** - 修复 reading/sync-full 500 错误
  - 只上传最近 90 天数据（最多 100 条）
  - 减少请求体大小，降低后端处理压力
- 🎫 **trust_level 权限检查优化** - 从 OAuth 用户信息获取等级
  - 避免低等级用户请求 requirements 接口

**后端优化 (backend)：**
- 🛡️ **D1 批量操作加固** - batchUpsertDailyReadings 增强
  - 批次大小从 50 减少到 20
  - 添加批次失败回退机制，单条插入保证数据不丢失
- 👤 **RequirementsService 自动创建用户** - 修复 404 错误
  - 三个方法均支持用户首次访问时自动创建记录

---

### v3.2.2 更新内容 ⚡ D1 免费额度优化

**客户端优化 (LDStatusPro.user.js)：**
- ⏰ **同步间隔优化** - 降低后端请求频率
  - 排行榜同步: 10分钟 → 15分钟
  - 云上传: 30分钟 → 60分钟
  - 云下载: 6小时 → 12小时
  - 云检查: 5分钟 → 10分钟
  - 新增升级要求同步间隔: 2小时
- 🔄 **指数退避重试** - 失败后自动增加等待时间
  - 首次失败等待 1 分钟，最大 30 分钟退避
  - 成功后自动重置
- 🎫 **权限缓存** - trust_level 检查结果缓存 24 小时
  - 低等级用户不再重复请求 requirements 接口
- 🚦 **串行化同步** - 页面加载时避免并发请求压力
  - reading 同步完成后再同步 requirements
  - 排行榜首次同步延迟 5 秒
- 📊 **排行榜缓存优化**
  - 日榜: 5分钟 → 10分钟
  - 周榜: 1小时 → 2小时
  - 月榜: 3小时 → 6小时

**后端优化 (backend)：**
- 📦 **批量写入** - `syncFullHistory` 使用 D1 batch 操作
  - reading: 每日数据批量写入，周/月统计按分组更新
  - requirements: 批量读取服务器数据，批量写入新数据
- 📖 **批量读取** - 一次查询获取所有历史数据，避免逐条查询
- 🗄️ **新增 D1 方法** - `batchUpsertDailyReadings` 批量更新每日阅读数据

**预期效果：**
- D1 读取次数: 减少约 70%
- D1 写入次数: 减少约 80%
- API 请求频率: 降低约 50%

---
### v3.2.1 更新内容 🌐 IDCFlare 全功能支持

**新功能：**
- 🌐 **IDCFlare 排行榜和云同步** - IDCFlare 站点现已支持完整的排行榜和云同步功能
  - 与 Linux.do 站点功能完全一致
  - 支持阅读时间排行榜（日榜/周榜/月榜）
  - 支持阅读数据云同步
  - 支持升级要求历史云同步 (trust_level >= 2)

**后端更新：**
- 🔐 **多站点 OAuth 支持** - 后端服务现支持多站点认证
  - 新增 IDCFlare OAuth 配置
  - 站点信息通过 URL 参数传递
  - 回调 URL 包含站点标识

**技术改进：**
- 前端 OAuth 请求携带 `site` 参数
- 后端 AuthService 支持动态站点配置
- 头像 URL 根据站点自动构建

---
### v3.2.0 更新内容 🔒 安全与性能优化

**安全增强（后端）：**
- 🛡️ **新增安全工具模块** - `backend/src/utils/security.js`
  - 全面的输入验证函数（用户ID、日期、分钟数等）
  - XSS 防护：HTML 字符转义函数
  - 字符串净化：移除控制字符、长度限制
  - JSON 安全：深度检查、大小限制
  - 升级要求数据验证
- 🔐 **服务层安全强化**
  - `reading.js`: 使用 security 模块验证所有输入
  - `requirements.js`: 强化数据验证和权限检查
  - `user.js`: 验证用户ID、用户名格式、限制信任等级范围

**安全增强（前端）：**
- 🛡️ **XSS 防护** - 新增 `Utils.escapeHtml()` 和 `Utils.sanitize()` 函数
- 🔒 **排行榜渲染安全** - 用户名和显示名称经过转义处理
- 🔐 **用户信息显示安全** - 清理所有用户输入再显示

**性能优化（后端）：**  
- ⚡ **用户缓存** - D1Database 类新增内存缓存，30秒 TTL
- 🚀 **缓存失效机制** - 用户数据更新时自动清除缓存

**性能优化（前端）：**
- ⚡ **API 响应缓存** - Network 类支持 GET 请求缓存
- 🔄 **请求去重** - 避免重复发送相同请求
- 📉 **减少 API 调用** - 缓存排行榜等高频请求

---
### v3.1.2 更新内容 🐛 趋势统计修复

**问题修复：**
- 🔧 **"全部"趋势标签页统计修复** - 修复"共记录 X 天数据"显示不正确的问题
  - 之前：错误地使用时间跨度计算，导致显示1天
  - 现在：正确使用 `history.length` 作为实际记录天数
- 📊 **日均阅读时间计算优化** - 使用实际有阅读记录的天数计算日均值
- ✨ **新增跨度显示** - 当跨度天数大于记录天数时，额外显示"跨度 X 天"
- 📈 **累计变化显示优化** - 添加当前值/目标值 (current/required) 显示

**UI改进：**
- 新增 `.ldsp-chg-cur` 样式，用于显示当前/目标值

---
### v3.1.1 更新内容 🔧 细节优化

**代码改进：**
- ⚡ **排行榜更新规则动态化** - 排行榜统计周期不再写死，而是从 `CONFIG.CACHE` 配置动态读取
  - 日榜: 每 5 分钟更新 (对应 `LEADERBOARD_DAILY_TTL`)
  - 周榜: 每 60 分钟更新 (对应 `LEADERBOARD_WEEKLY_TTL`)
  - 月榜: 每 3 小时更新 (对应 `LEADERBOARD_MONTHLY_TTL`)
- 🎯 修改配置即可自动更新显示文案，无需同步修改多处代码

**用户信息区域确认：**
- 头像（带悬停"查看"提示）
- 昵称 (displayName) + @用户名 (username)
- 信任等级 (Lv X)
- 升级要求进度 (X/Y 完成)

---
### v3.1.0 更新内容 ☁️ 升级要求数据云同步

**新增功能：**
- ☁️ **升级要求历史云同步** - 支持升级要求数据的跨设备同步
  - 自动上传本地升级要求历史到云端
  - 新设备登录时自动下载云端数据
  - 数据合并策略：取各字段的较大值，防止数据丢失
  - **权限要求**: 仅 `trust_level >= 2` 用户可用

**UI/UX 改进：**
- 🎨 **头像悬停提示** - 头像悬停时显示"查看"tooltip
- 👤 **用户名显示优化** - 登录后正确显示昵称而非仅用户名

**问题修复：**
- 🔧 修复 `_bindLoginPrompt()` 中按钮禁用状态设置错误的问题
- 🔧 修复 `oauth.getUser()` 方法不存在的调用错误
- 🔧 修复登录后界面未正确更新用户信息的问题

**后端更新 (v3.2.0)：**
- 新增 `requirements_history` 数据表
- 新增 `/api/requirements/sync` - 同步单日升级要求
- 新增 `/api/requirements/sync-full` - 上传完整历史
- 新增 `/api/requirements/history` - 获取历史数据

---
### v3.0.4 更新内容 🐛 Bug修复与体验优化

**问题修复：**
- 🔧 **低信任等级用户体验修复** - 修复 trust_level < 2 用户无法正常使用的问题
  - 修复 "Cannot read properties of undefined (reading '$')" 错误
  - 登录后正确显示用户信息（头像、昵称、等级）
  - 不再卡在"加载中"状态
- 🔧 **事件绑定修复** - 修复排行榜登录/加入按钮点击后被禁用的问题
  - 使用箭头函数替代 `.bind(this)` 避免 this 指向错误
  - 按钮状态正确更新

**交互优化：**
- 🎨 **头像交互增强** - 头像悬停时显示缩放和发光效果

**代码改进：**
- ✨ 新增 `_updateUserInfoFromOAuth()` 方法，从 OAuth 数据更新用户界面
- ⚡ 页面加载时自动显示已登录用户信息

---
### v3.0.3 更新内容 🎨 体验优化与功能增强

**排行榜优化：**
- 🎨 **用户显示样式升级** - 排行榜现在显示 name + @username 组合
  - 有昵称时：粗体昵称 + 浅色小号用户名
  - 无昵称时：保持原有粗体用户名样式
- 🔄 **手动刷新功能** - 排行榜统计周期旁新增刷新按钮
  - 支持手动获取最新排行榜数据
  - 5分钟冷却时间，各榜独立计算
  - 刷新时显示旋转动画和状态提示

**缓存策略优化：**
- ⏱️ **前端缓存时间调整**
  - 日榜：5分钟（与服务器更新频率匹配）
  - 周榜：60分钟
  - 月榜：3小时

**版本更新提醒：**
- 🎉 **智能更新气泡** - 发现新版本时显示醒目的气泡提示
  - 显示当前版本 → 新版本对比
  - 一键点击立即更新
  - 关闭后同版本不再重复提示
  - 检查按钮有更新时显示脉冲动画

**趋势显示修复：**
- 📊 本月/本年趋势数据显示条件优化（1条记录即可显示）

**信任等级兼容：**
- 🔐 **信任等级 < 2 支持** - 现在低信任等级用户也能使用阅读时间追踪功能
  - 无法获取升级要求时显示友好提示
  - 阅读追踪功能正常运行

**代码优化：**
- 🚀 重构排行榜事件绑定逻辑，消除重复代码
- ⚡ 使用 onclick 替代重复的 addEventListener，避免内存泄漏

---
### v3.0.1 更新内容 🚀 架构升级 - 存储迁移至 D1
**重大更新：**
- 🗄️ **存储后端迁移** - 从 Cloudflare KV 迁移到 D1 SQL 数据库
  - 写入限额从 1,000/天 提升到 100,000/天（**100 倍提升**）
  - 读取限额从 100,000/天 提升到 5,000,000/天（50 倍提升）
  - 存储空间从 1GB 提升到 5GB（5 倍提升）
  - 支持约 10,000-20,000 日活用户，原先仅支持 100-200 人

**技术改进：**
- 新增 `D1Database` 工具类封装所有数据库操作
- 排行榜计算使用 SQL 聚合查询，性能大幅提升
- 数据完全无损迁移，用户无感知升级
- 保留 KV 绑定用于迁移期间兼容

**迁移指南：**
1. 部署新版本后端
2. 通过 `/api/admin/migrate` 执行数据迁移
3. 验证数据完整性后移除 KV 引用

---
### v3.0.0 更新内容 🎉 重大更新 - 排行榜功能上线

**新增功能:**
- 🏆 **排行榜系统** - 全新的排行榜功能，与其他用户一较高下
  - 支持日榜、周榜、月榜三个时间维度
  - 展示前 50 名用户的阅读时间排名
  - 金银铜牌前三名特殊展示效果
- 🔐 **OAuth 登录** - 使用 Linux.do 账号安全授权
- 🛡️ **隐私优先** - 用户自主选择是否加入排行榜，随时可退出
- 👤 **我的排名** - 查看自己在各榜单中的位置
- 📡 **数据同步** - 阅读时间自动同步到云端排行榜

**技术实现:**
- 新增 `OAuthManager` 类处理 OAuth2 认证流程
- 新增 `LeaderboardManager` 类管理排行榜数据
- 新增排行榜 Tab UI 和相关样式
- 后端使用 Cloudflare Workers + KV 存储 (见 `backend/` 目录)

**其他:**
- 版本号升级到 3.0.0
- 更新 README 文档

---
### v3.0.1 更新内容 🔧 修复与性能优化
**修复与改进：**
- 修复 OAuth 登录后用户名未同步到本地 storage 的问题（导致云同步无法正确读取/写入用户数据）
- 修复云端下载超时问题：将后端 KV 读取从串行改为并行，并批处理以提升性能
- 优化 `getFullHistory` 接口，使用 KV list 获取用户全部阅读记录，避免时区或缺失数据问题
- 添加手动同步按钮（顶部 ☁️），支持完整的下载+上传流程
- 同步过程中按钮显示加载状态并禁用点击，防止重复触发
- 优化客户端缓存策略，日榜客户端缓存改为 5 分钟，服务器端 Cron 改为每 10 分钟计算
- 修复其他小 bug 与 UX 改进

**其他:**
- 版本号升级到 3.0.1
- 更新 README 与 DOCS 文档说明

---
### v2.8.7更新内容
- 现在缩小后的悬浮图标也支持拖动啦，展开和收缩动画优化。
- 修复明暗主题切换可能出现的UI闪烁问题。
- 增量统计部分的显示和数据调整。
- 一些动画优化和调整。