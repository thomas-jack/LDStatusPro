# LDStatusPro 详细说明文档

> 本文档详细说明 LDStatusPro 的各项功能、数据存储、同步机制及规则。

## 📑 目录

- [数据存储说明](#数据存储说明)
- [阅读时间统计规则](#阅读时间统计规则)
- [阅读等级系统](#阅读等级系统)
- [云同步机制](#云同步机制)
- [排行榜系统](#排行榜系统)
- [信任等级追踪](#信任等级追踪)
- [界面功能说明](#界面功能说明)
- [常见问题](#常见问题)

---

## 数据存储说明

LDStatusPro 使用两种存储方式：**本地存储** 和 **云端存储**。

### 本地存储（浏览器）

以下数据仅存储在当前浏览器中，不会同步到云端：

| 存储键 | 说明 | 示例值 |
|--------|------|--------|
| `ldsp_position` | 面板位置 | `{x: 100, y: 200}` |
| `ldsp_collapsed` | 面板折叠状态 | `true` / `false` |
| `ldsp_theme` | 界面主题 | `'auto'` / `'dark'` / `'light'` |
| `ldsp_history` | 信任等级历史记录 | `[{level: 2, date: '2024-01-01'}]` |
| `ldsp_milestones` | 已显示的里程碑 | `['1h', '10h', '100h']` |
| `ldsp_lastVisit` | 上次访问时间 | `1702444800000` |
| `ldsp_trendTab` | 趋势图当前标签 | `'week'` / `'month'` |
| `ldsp_leaderboardTab` | 排行榜当前标签 | `'daily'` / `'weekly'` / `'monthly'` |
| `ldsp_userAvatar` | 用户头像 URL | `'https://...'` |

**认证相关（本地存储，但与服务器保持同步）：**

| 存储键 | 说明 |
|--------|------|
| `ldsp_leaderboardToken` | JWT 认证令牌 |
| `ldsp_leaderboardUser` | 用户名 |
| `ldsp_leaderboardJoined` | 是否已加入排行榜 |
| `ldsp_loginPrompted` | 是否已提示过登录 |

### 云端存储（服务器）

以下数据会同步到云端服务器：

| 数据类型 | 说明 | 同步内容 |
|----------|------|----------|
| `readingTime.dailyData` | 每日阅读数据 | 每天的 `totalMinutes`（总分钟数）和 `lastActive`（最后活跃时间） |

**云端存储的数据结构示例：**

```json
{
  "2024-12-13": {
    "totalMinutes": 45,
    "lastActive": 1702444800000
  },
  "2024-12-12": {
    "totalMinutes": 120,
    "lastActive": 1702358400000
  }
}
```

---

## 阅读时间统计规则

### 统计机制

LDStatusPro 通过检测用户在页面上的活动来统计阅读时间：

1. **活动检测**：监听以下用户活动
   - 鼠标移动 (`mousemove`)
   - 鼠标点击 (`mousedown`)
   - 键盘输入 (`keydown`)
   - 页面滚动 (`scroll`)
   - 触摸操作 (`touchstart`)

2. **统计间隔**：每 **10 秒** 检查一次用户活动状态

3. **有效活动判定**：
   - 页面必须处于可见状态（`document.visibilityState === 'visible'`）
   - 用户在过去 **60 秒** 内有上述任一活动（超过 60 秒无活动视为不活跃）
   - 满足条件则累计阅读时间

4. **统计范围**：仅在 `linux.do` 域名下统计

### 时间计算

- **今日阅读**：当天累计的有效阅读分钟数
- **本周阅读**：本周一至今的累计阅读时间
- **本月阅读**：本月1日至今的累计阅读时间
- **总计阅读**：所有历史阅读时间的总和

### 数据重置

- **每日数据**：每天 00:00 自动重置今日计数
- **历史数据**：永久保存，除非手动清除浏览器数据

---

## 阅读等级系统

### 等级定义

根据 **今日阅读时间** 划分为以下等级（每日重置）：

| 等级 | 名称 | 所需时间（分钟） | 图标 | 颜色 |
|------|------|------------------|------|------|
| 1 | 刚起步 | 0 - 30 | 🌱 | `#94a3b8` |
| 2 | 热身中 | 30 - 90 | 📖 | `#60a5fa` |
| 3 | 渐入佳境 | 90 - 180 | 📚 | `#34d399` |
| 4 | 沉浸阅读 | 180 - 300 | 🔥 | `#fbbf24` |
| 5 | 深度学习 | 300 - 450 | ⚡ | `#f97316` |
| 6 | LD达人 | 450 - 600 | 🏆 | `#a855f7` |
| 7 | 超级水怪 | 600+ | 👑 | `#ec4899` |

### 等级计算公式

```javascript
const READING_LEVELS = [
  { min: 0, label: '刚起步', icon: '🌱' },
  { min: 30, label: '热身中', icon: '📖' },
  { min: 90, label: '渐入佳境', icon: '📚' },
  { min: 180, label: '沉浸阅读', icon: '🔥' },
  { min: 300, label: '深度学习', icon: '⚡' },
  { min: 450, label: 'LD达人', icon: '🏆' },
  { min: 600, label: '超级水怪', icon: '👑' }
];

function getLevel(todayMinutes) {
  for (let i = READING_LEVELS.length - 1; i >= 0; i--) {
    if (todayMinutes >= READING_LEVELS[i].min) {
      return READING_LEVELS[i];
    }
  }
  return READING_LEVELS[0];
}
```

### 里程碑提醒

当以下指标达到特定阈值时会显示庆祝动画：

| 指标 | 里程碑阈值 |
|------|------------|
| 浏览话题 | 100 → 500 → 1000 → 2000 → 5000 |
| 已读帖子 | 500 → 1000 → 5000 → 10000 → 20000 |
| 获赞 | 10 → 50 → 100 → 500 → 1000 |
| 送出赞 | 50 → 100 → 500 → 1000 → 2000 |
| 回复 | 10 → 50 → 100 → 500 → 1000 |

---

## 云同步机制

### 同步配置

| 配置项 | 值 | 说明 |
|--------|-----|------|
| `UPLOAD_INTERVAL` | 30 分钟 | 上传数据的最小间隔 |
| `DOWNLOAD_INTERVAL` | 6 小时 | 下载数据的最小间隔 |
| `CHECK_INTERVAL` | 5 分钟 | 检查是否需要同步的间隔 |

### 同步流程

#### 上传同步（本地 → 云端）

1. **触发条件**：
   - 距离上次上传超过 30 分钟
   - 本地数据有更新

2. **上传内容**：
   - 所有 `dailyData` 中的阅读记录
   - 格式：`{ dailyData: { "2024-12-13": { totalMinutes, lastActive }, ... } }`

3. **合并策略**：服务器会保留 `totalMinutes` 较大的记录

#### 下载同步（云端 → 本地）

1. **触发条件**：
   - 距离上次下载超过 6 小时
   - 或检测到新设备（本地无数据）

2. **新设备检测**：
   ```javascript
   const isNewDevice = !hasLocalData || lastDownloadSync === 0;
   ```

3. **合并策略**：本地会保留 `totalMinutes` 较大的记录

### 同步状态显示

面板顶部的 ☁️ 按钮显示同步状态：
- ☁️ - 空闲状态，点击可手动同步
- ⏳ - 正在同步中

### 手动同步

用户可以随时点击面板顶部的 ☁️ 按钮手动触发完整同步：
1. 先从云端下载最新数据并合并到本地
2. 再将本地数据上传到云端
3. 同步完成后显示提示

---

## 排行榜系统

### 排行榜类型

| 类型 | 统计范围 | 服务器更新频率 | 前端缓存时间 |
|------|----------|----------------|--------------|
| 日榜 | 当天 00:00 至今 | 每 5 分钟（Cron 定时） | 5 分钟 |
| 周榜 | 本周一至今 | 每小时（Cron 定时） | 60 分钟 |
| 月榜 | 本月1日至今 | 每 3 小时（Cron 定时） | 3 小时 |

### 服务器端计算机制

排行榜采用 **Cron Triggers 定时预计算** 机制：

1. **日榜**：每 5 分钟由 Cloudflare Cron 自动触发计算，结果存入 D1 数据库缓存
2. **周榜**：每小时自动计算
3. **月榜**：每 3 小时自动计算

这意味着：
- 用户请求时直接读取缓存，响应更快
- 排行榜按固定间隔更新，更可预测
- 首次部署或缓存丢失时会按需计算

### 前端缓存机制

- **前端不会自动请求 API**，只有当用户点击对应标签时才会尝试获取数据
- 首次请求会将排行榜数据缓存到本地
- 后续请求会检查缓存是否过期，未过期则使用本地缓存

### 参与条件

1. **登录**：通过 Linux.do Connect OAuth 登录
2. **加入**：点击"加入排行榜"按钮确认参与

### 排名规则

- 按对应时间段内的 **总阅读分钟数** 降序排列
- 相同时间的用户按 **用户名字母顺序** 排列
- 显示前 **50** 名用户

### 数据更新

- 排行榜数据来自各用户的云同步数据
- 用户需要登录并同步数据后才会出现在排行榜
- 排行榜会根据缓存策略定期更新

### 排行榜显示

- 显示排名、用户名、阅读时间
- 当前用户会高亮显示
- 支持点击用户名跳转到用户主页

---

## 信任等级追踪

### 功能说明

LDStatusPro 会追踪并记录你在 Linux.do 的信任等级变化历史。

### 等级获取

信任等级从页面的用户信息中自动获取，无需手动输入。

### 历史记录

- 每当检测到等级变化时，自动记录新等级和日期
- 历史记录存储在本地，不会同步到云端
- 可在面板的"等级历史"区域查看变化记录

### 等级变化提醒

当检测到等级变化时：
- 等级 **提升**：显示祝贺动画 🎉
- 等级 **下降**：显示提醒通知 ⚠️

---

## 界面功能说明

### 主面板

- **位置**：默认显示在页面右下角，可拖动调整位置
- **折叠**：点击面板头部可折叠/展开
- **主题**：支持自动/深色/浅色三种主题

### 面板内容

1. **用户信息区**
   - 头像和用户名
   - 信任等级徽章
   - 未登录时显示"点击登录"提示

2. **今日阅读**
   - 当天累计阅读时间
   - 实时更新

3. **阅读等级**
   - 当前等级名称和图标
   - 升级进度条
   - 距离下一等级的剩余时间

4. **阅读趋势图**
   - 周视图：最近 7 天的每日阅读时间
   - 月视图：最近 30 天的每日阅读时间

5. **排行榜**
   - 日榜/周榜/月榜切换
   - 显示排名、用户名、阅读时间
   - 当前用户高亮显示

6. **状态栏**
   - 同步状态指示
   - 版本信息

### 快捷操作

- **双击头像**：刷新用户信息
- **拖动面板**：调整面板位置
- **点击折叠按钮**：折叠/展开面板

---

## 常见问题

### Q: 为什么我的阅读时间没有增加？

**A:** 请检查以下情况：
1. 页面是否处于可见状态（未最小化、未切换到其他标签页）
2. 是否在 linux.do 域名下
3. 是否有鼠标移动、滚动等活动

### Q: 换了浏览器/设备，数据会丢失吗？

**A:** 
- 如果已登录并开启云同步，**阅读时间数据** 会自动同步到新设备
- 界面设置（主题、面板位置等）需要重新配置
- 信任等级历史记录不会同步

### Q: 排行榜多久更新一次？

**A:**
- 服务器端：日榜每 5 分钟计算一次，周榜每小时计算一次，月榜每 3 小时计算一次
- 客户端缓存：日榜 5 分钟，周榜 60 分钟，月榜 3 小时
- 支持手动刷新（每个榜单独立 5 分钟冷却）
- 你的数据需要先通过云同步上传后才会反映在排行榜中

### Q: 为什么我没有出现在排行榜上？

**A:** 请确认：
1. 已通过 Linux.do Connect 登录
2. 已点击"加入排行榜"按钮
3. 已等待数据同步完成

### Q: 如何退出排行榜？

**A:** 目前不支持主动退出排行榜。如有需要，请联系开发者。

### Q: 数据存储是否安全？

**A:**
- 本地数据存储在浏览器的 localStorage 中
- 云端数据存储在 Cloudflare KV 中，与你的 Linux.do 账号关联
- 不会收集任何敏感信息

### Q: 如何完全清除数据？

**A:**
1. **清除本地数据**：在浏览器开发者工具中执行 `localStorage.clear()`
2. **清除云端数据**：目前不支持用户自行清除，请联系开发者

---

## 技术架构

### 前端

- **框架**：原生 JavaScript (Tampermonkey 用户脚本)
- **存储**：localStorage
- **UI**：纯 CSS + 原生 DOM 操作

### 后端

- **运行时**：Cloudflare Workers
- **存储**：Cloudflare KV
- **认证**：Linux.do Connect OAuth + JWT

### API 端点

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/auth/login` | POST | 发起 OAuth 登录 |
| `/api/auth/callback` | POST | OAuth 回调处理 |
| `/api/reading/sync` | POST | 同步阅读数据 |
| `/api/leaderboard/daily` | GET | 获取日排行榜 |
| `/api/leaderboard/weekly` | GET | 获取周排行榜 |
| `/api/leaderboard/monthly` | GET | 获取月排行榜 |
| `/api/user/join` | POST | 加入排行榜 |
| `/api/user/status` | GET | 获取用户状态 |

---

## 版本历史

请查看 [update_log.md](./update_log.md) 获取完整的版本更新历史。

---

## 反馈与支持

如有问题或建议，请通过以下方式联系：

- GitHub Issues: [项目地址]
- Linux.do 论坛私信

---

*最后更新：2025 年 12 月*
