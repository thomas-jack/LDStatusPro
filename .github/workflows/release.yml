# GitHub Actions è‡ªåŠ¨å‘å¸ƒå·¥ä½œæµ
# å½“æ¨é€å¸¦æœ‰ v* æ ‡ç­¾æ—¶è‡ªåŠ¨åˆ›å»º Release
#
# è§¦å‘æ–¹å¼:
#   1. ä½¿ç”¨ release.ps1 è„šæœ¬ï¼ˆæ¨èï¼‰
#   2. æ‰‹åŠ¨åˆ›å»ºå¹¶æ¨é€ tag: git tag -a v3.4.7 -m "Release v3.4.7" && git push origin v3.4.7

name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ä¾¿æå– changelog
      
      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Extract changelog
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          VERSION_NUM="${VERSION#v}"
          
          echo "Looking for version: $VERSION_NUM"
          
          # å°è¯•å¤šç§æ ¼å¼æå– changelog
          # æ ¼å¼1: ### 3.4.7 (2024-xx-xx)
          # æ ¼å¼2: ### v3.4.7
          # æ ¼å¼3: ## 3.4.7
          
          if [ -f "update_log.md" ]; then
            # æå–ä»å½“å‰ç‰ˆæœ¬åˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬æ ‡è®°ä¹‹é—´çš„å†…å®¹
            CHANGELOG=$(awk "
              /^###? v?${VERSION_NUM}/ { found=1; next }
              /^###? v?[0-9]+\.[0-9]+\.[0-9]+/ { if(found) exit }
              found { print }
            " update_log.md)
            
            # æ¸…ç†ç©ºè¡Œ
            CHANGELOG=$(echo "$CHANGELOG" | sed '/^$/d' | head -20)
          fi
          
          # å¦‚æœæ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨é»˜è®¤å†…å®¹
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="è¯·æŸ¥çœ‹ [update_log.md](./update_log.md) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚"
          fi
          
          # ä¿å­˜åˆ° GitHub Output (ä½¿ç”¨ heredoc æ”¯æŒå¤šè¡Œ)
          {
            echo 'CHANGELOG<<CHANGELOG_EOF'
            echo "$CHANGELOG"
            echo 'CHANGELOG_EOF'
          } >> $GITHUB_OUTPUT
          
          echo "Extracted changelog:"
          echo "$CHANGELOG"
      
      - name: Get script info
        id: script_info
        run: |
          # ä»è„šæœ¬ä¸­æå–ä¿¡æ¯
          SCRIPT_NAME=$(grep -oP '// @name\s+\K.*' LDStatusPro.user.js | head -1)
          SCRIPT_DESC=$(grep -oP '// @description\s+\K.*' LDStatusPro.user.js | head -1)
          
          echo "SCRIPT_NAME=$SCRIPT_NAME" >> $GITHUB_OUTPUT
          echo "SCRIPT_DESC=$SCRIPT_DESC" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.script_info.outputs.SCRIPT_NAME }} ${{ steps.version.outputs.VERSION }}
          body: |
            ## ğŸ‰ ${{ steps.version.outputs.VERSION }} æ›´æ–°å†…å®¹
            
            ${{ steps.changelog.outputs.CHANGELOG }}
            
            ---
            
            ## ğŸ“¥ å®‰è£…æ–¹å¼
            
            ### æ–¹å¼ä¸€ï¼šç›´æ¥å®‰è£…ï¼ˆæ¨èï¼‰
            
            ç¡®ä¿å·²å®‰è£…è„šæœ¬ç®¡ç†å™¨ï¼Œç„¶åç‚¹å‡»ä¸‹æ–¹é“¾æ¥ï¼š
            
            **[ğŸ”— ç‚¹å‡»å®‰è£… LDStatus Pro](https://raw.githubusercontent.com/${{ github.repository }}/main/LDStatusPro.user.js)**
            
            ### æ–¹å¼äºŒï¼šä» GreasyFork å®‰è£…
            
            è®¿é—® [GreasyFork é¡µé¢](https://greasyfork.org/scripts/YOUR_SCRIPT_ID) å®‰è£…ï¼ˆå¯èƒ½æœ‰å»¶è¿Ÿï¼‰
            
            ---
            
            ## ğŸ“‹ æ”¯æŒçš„è„šæœ¬ç®¡ç†å™¨
            
            | å¹³å° | è„šæœ¬ç®¡ç†å™¨ | çŠ¶æ€ |
            |------|-----------|------|
            | Chrome/Edge/Firefox | Tampermonkey | âœ… å®Œå…¨æ”¯æŒ |
            | Chrome/Edge/Firefox | Violentmonkey | âœ… å®Œå…¨æ”¯æŒ |
            | Safari (macOS) | Tampermonkey / Userscripts | âœ… å®Œå…¨æ”¯æŒ |
            | Safari (iOS) | Stay | âœ… å®Œå…¨æ”¯æŒ |
            
            ---
            
            ## ğŸ”„ å¦‚ä½•æ›´æ–°
            
            - **è‡ªåŠ¨æ›´æ–°**: è„šæœ¬ç®¡ç†å™¨ä¼šå®šæœŸæ£€æŸ¥æ›´æ–°ï¼ˆé€šå¸¸ 1-24 å°æ—¶ï¼‰
            - **æ‰‹åŠ¨æ›´æ–°**: åœ¨è„šæœ¬ç®¡ç†å™¨ä¸­ç‚¹å‡»"æ£€æŸ¥æ›´æ–°"
            
          files: |
            LDStatusPro.user.js
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, 'beta') || contains(steps.version.outputs.VERSION, 'alpha') }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
